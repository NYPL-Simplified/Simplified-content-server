#!/usr/bin/env python
"""Update the content server with new open-access books from FeedBooks."""
import logging
import os
import sys
bin_dir = os.path.split(__file__)[0]
package_dir = os.path.join(bin_dir, "..")
sys.path.append(os.path.abspath(package_dir))

from core.model import (
    DataSource,
    ExternalIntegration,
    Collection,
    ConfigurationSetting,
)

from scripts import OPDSImportScript
from feedbooks import FeedbooksOPDSImporter


import_script = OPDSImportScript(FeedbooksOPDSImporter, DataSource.FEEDBOOKS)
collections = import_script._db.query(Collection)\
    .join(ExternalIntegration, Collection.external_integration_id==ExternalIntegration.id)\
    .join(ExternalIntegration.settings)\
    .filter(ConfigurationSetting.key==Collection.DATA_SOURCE_NAME_SETTING)\
    .filter(ConfigurationSetting.value==DataSource.FEEDBOOKS)

for collection in collections:
    import_script.collection = collection
    print ('*' * 30) + collection.name + ': ' + collection.external_account_id + ('*' * 30)
    import_script.run()
    import_script._db.commit()
